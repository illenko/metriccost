services:
  whodidthis:
    image: illenko/whodidthis:0.0.3
    ports:
      - "8080:8080"
    environment:
      - WDT_DISCOVERY_SERVICE_LABEL=job
      - WDT_LOG_LEVEL=info
      - WDT_SCAN_CONCURRENCY=5
      - WDT_PROMETHEUS_URL=http://host.docker.internal:8428
      - WDT_SCAN_INTERVAL=1d
      - WDT_SCAN_SAMPLE_VALUES_LIMIT=10
      - WDT_SERVER_HOST=0.0.0.0
      - WDT_SERVER_PORT=8080
      - WDT_STORAGE_PATH=/app/data/whodidthis.db
      - WDT_STORAGE_RETENTION_DAYS=14
      - WDT_GEMINI_API_KEY=${GEMINI_API_KEY}
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s